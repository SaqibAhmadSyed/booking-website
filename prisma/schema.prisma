generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS
enum UserRole {
  user
  admin
}

enum BookingStatus {
  pending
  approved
  rejected
  cancelled
}

enum ConcordiaBuilding {
  H
  LB
  EV
  GN
  MB
  FB
  FG
  AD
  CC
  PY
  SP
  RA
  PC
  VL
  JR
}

// USERS
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String?
  role          UserRole  @default(user)
  first_name    String?
  last_name     String?
  student_id    BigInt?   @unique
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  bookings Booking[]

  @@map("users")
}

// RESOURCE SCHEDULE
model Resource_Schedule {
  id              BigInt            @id @default(autoincrement())
  resource_id     String
  building        ConcordiaBuilding
  room_number     String?
  day_of_week     Int
  start_time      DateTime
  end_time        DateTime
  effective_from  DateTime?
  effective_until DateTime?

  resource Resource @relation(fields: [resource_id], references: [id])
}

// RESOURCE
model Resource {
  id        String            @id @default(cuid())
  name      String
  type      String
  location  ConcordiaBuilding
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  schedules     Resource_Schedule[]
  bookings      Booking[]
  hourlyStats   Hourly_Statistics[]
  weeklyStats   Weekly_Statistics[]
  statusStats   Status_Statistics[]
  blackoutDates Blackout_Date[]
  buildingStats Building_Statistics[]
  mostBookedIn  Building_Statistics[] @relation("MostBookedResource")
}

// BUILDING STATISTICS
model Building_Statistics {
  id                      BigInt            @id @default(autoincrement())
  building                ConcordiaBuilding
  stat_date               DateTime
  total_rooms_booked      Int               @default(0)
  total_bookings          Int               @default(0)
  total_hours             Int               @default(0)
  unique_users            Int               @default(0)
  occupancy_rate          Float?
  most_booked_resource_id String?
  resource_id             String?
  created_at              DateTime          @default(now())

  resource           Resource? @relation(fields: [resource_id], references: [id])
  mostBookedResource Resource? @relation("MostBookedResource", fields: [most_booked_resource_id], references: [id])
}

// BOOKING
model Booking {
  id                 BigInt        @id @default(autoincrement())
  user_id            String
  resource_id        String
  date               DateTime
  day_of_week        Int
  week_num           Int?
  start_time         DateTime
  end_time           DateTime
  purpose            String?
  status             BookingStatus @default(pending)
  cancelation_reason String?
  created_at         DateTime      @default(now())

  user     User     @relation(fields: [user_id], references: [id])
  resource Resource @relation(fields: [resource_id], references: [id])
}

// HOURLY STATISTICS
model Hourly_Statistics {
  id                     BigInt   @id @default(autoincrement())
  resource_id            String
  booking_hour           Int
  stat_date              DateTime
  total_bookings         Int      @default(0)
  total_duration_minutes Int      @default(0)
  unique_users           Int      @default(0)
  created_at             DateTime @default(now())

  resource Resource @relation(fields: [resource_id], references: [id])
}

// WEEKLY STATISTICS
model Weekly_Statistics {
  id                   BigInt   @id @default(autoincrement())
  resource_id          String
  year                 Int
  week_number          Int
  week_start_date      DateTime
  total_bookings       Int      @default(0)
  total_hours          Int      @default(0)
  unique_users         Int      @default(0)
  avg_booking_duration Int      @default(0)
  created_at           DateTime @default(now())

  resource Resource @relation(fields: [resource_id], references: [id])
}

// STATUS STATISTICS
model Status_Statistics {
  id                BigInt   @id @default(autoincrement())
  resource_id       String
  stat_date         DateTime
  pending_count     Int      @default(0)
  approved_count    Int      @default(0)
  rejected_count    Int      @default(0)
  cancelled_count   Int      @default(0)
  approval_rate     Float?
  cancellation_rate Float?
  created_at        DateTime @default(now())

  resource Resource @relation(fields: [resource_id], references: [id])
}

// BLACKOUT DATES
model Blackout_Date {
  id          BigInt   @id @default(autoincrement())
  resource_id String
  date        DateTime
  reason      String?
  created_at  DateTime @default(now())

  resource Resource @relation(fields: [resource_id], references: [id])
}
