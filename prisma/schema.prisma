generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ENUMS
enum UserRole {
  user
  admin
}

enum BookingStatus {
  pending
  approved
  rejected
  cancelled
}

enum ConcordiaBuilding {
  H
  LB
  EV
  GN
  MB
  FB
  FG
  AD
  CC
  PY
  SP
  RA
  PC
  VL
  JR
}

// USERS
model user {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String
  role          UserRole  @default(user)
  first_name    String
  last_name     String
  student_id    BigInt    @unique
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  bookings booking[]

  @@map("users")
}

// RESOURCE SCHEDULE
model resource_schedule {
  id              BigInt            @id @default(autoincrement())
  resource_id     String
  building        ConcordiaBuilding
  room_number     String
  day_of_week     Int
  start_time      DateTime
  end_time        DateTime
  effective_from  DateTime?
  effective_until DateTime?

  resource resource @relation(fields: [resource_id], references: [id])
}

// RESOURCE
model resource {
  id          String   @id @default(cuid())
  name        String
  location    String
  type        String
  capacity    Int
  amenities   String[]
  description String?
  image    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  schedules     resource_schedule[]
  bookings      booking[]
  hourlyStats   hourly_statistics[]
  weeklyStats   weekly_statistics[]
  statusStats   status_statistics[]
  blackoutDates blackout_date[]
  buildingStats building_statistics[]
  mostBookedIn  building_statistics[] @relation("mostBookedResource")
}

// BUILDING STATISTICS
model building_statistics {
  id                      BigInt            @id @default(autoincrement())
  building                ConcordiaBuilding
  stat_date               DateTime
  total_rooms_booked      Int               @default(0)
  total_bookings          Int               @default(0)
  total_hours             Int               @default(0)
  unique_users            Int               @default(0)
  occupancy_rate          Float?
  most_booked_resource_id String?
  resource_id             String?
  created_at              DateTime          @default(now())

  resource           resource? @relation(fields: [resource_id], references: [id])
  mostBookedResource resource? @relation("mostBookedResource", fields: [most_booked_resource_id], references: [id])
}

// BOOKING
model booking {
  id                 BigInt        @id @default(autoincrement())
  user_id            String
  resource_id        String
  date               DateTime
  day_of_week        Int
  week_num           Int?
  start_time         DateTime
  end_time           DateTime
  purpose            String?
  status             BookingStatus @default(pending)
  cancelation_reason String?
  created_at         DateTime      @default(now())

  user     user     @relation(fields: [user_id], references: [id])
  resource resource @relation(fields: [resource_id], references: [id])
}

// HOURLY STATISTICS
model hourly_statistics {
  id                     BigInt   @id @default(autoincrement())
  resource_id            String
  booking_hour           Int
  stat_date              DateTime
  total_bookings         Int      @default(0)
  total_duration_minutes Int      @default(0)
  unique_users           Int      @default(0)
  created_at             DateTime @default(now())

  resource resource @relation(fields: [resource_id], references: [id])
}

// WEEKLY STATISTICS
model weekly_statistics {
  id                   BigInt   @id @default(autoincrement())
  resource_id          String
  year                 Int
  week_number          Int
  week_start_date      DateTime
  total_bookings       Int      @default(0)
  total_hours          Int      @default(0)
  unique_users         Int      @default(0)
  avg_booking_duration Int      @default(0)
  created_at           DateTime @default(now())

  resource resource @relation(fields: [resource_id], references: [id])
}

// STATUS STATISTICS
model status_statistics {
  id                BigInt   @id @default(autoincrement())
  resource_id       String
  stat_date         DateTime
  pending_count     Int      @default(0)
  approved_count    Int      @default(0)
  rejected_count    Int      @default(0)
  cancelled_count   Int      @default(0)
  approval_rate     Float?
  cancellation_rate Float?
  created_at        DateTime @default(now())

  resource resource @relation(fields: [resource_id], references: [id])
}

// BLACKOUT DATES
model blackout_date {
  id          BigInt   @id @default(autoincrement())
  resource_id String
  date        DateTime
  reason      String?
  created_at  DateTime @default(now())

  resource resource @relation(fields: [resource_id], references: [id])
}
